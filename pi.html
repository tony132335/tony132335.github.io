<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi 极速计算器 (修复版)</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #0d0d0d;
            color: #00ff41;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        h1 { margin: 10px 0; text-shadow: 0 0 10px rgba(0, 255, 65, 0.4); }
        .tag { font-size: 0.8em; background: #222; padding: 2px 8px; border-radius: 4px; color: #fff; margin-bottom: 20px; }
        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            border: 1px solid #333;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        input[type="number"] {
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            width: 120px;
            font-size: 16px;
            border-radius: 4px;
        }
        button { padding: 10px 24px; font-size: 16px; cursor: pointer; background-color: #007acc; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #006bb3; }
        button:disabled { opacity: 0.5; cursor: wait; background-color: #444; }

        .stats-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 10px;
        }
        .stat-card { background: #111; padding: 10px; border-left: 3px solid #007acc; }
        .stat-label { color: #888; font-size: 0.9em; display: block; }
        .stat-value { color: #fff; font-size: 1.2em; font-weight: bold; }

        #status-text { height: 20px; color: #ff9800; font-weight: bold; margin-bottom: 5px; }
        #result-area {
            flex: 1; width: 100%; max-width: 1200px;
            background-color: #000; border: 1px solid #333; padding: 15px;
            border-radius: 4px; overflow-y: auto; word-wrap: break-word;
            font-size: 14px; line-height: 1.4; color: #ccc;
        }
    </style>
</head>
<body>

<h1>&pi; Pi 极速版 (v2 修复)</h1>
<span class="tag">Chudnovsky + Safe BigInt</span>

<div class="controls">
    <label>目标位数: <input type="number" id="targetDigits" value="20000" step="1000"></label>
    <button id="btnCalc" onclick="startCalc()">立即计算</button>
</div>

<div id="status-text"></div>

<div class="stats-panel">
    <div class="stat-card">
        <span class="stat-label">总耗时</span>
        <span class="stat-value" id="timeVal">0.00 s</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">实际结果长度</span>
        <span class="stat-value" id="lenVal">0</span>
    </div>
</div>

<div id="result-area">准备就绪...</div>

<!-- Worker 代码作为纯文本存放 -->
<script id="worker-code" type="text/plain">
self.onmessage = function(e) {
    const digits = BigInt(e.data);

    try {
        const start = performance.now();
        const C = 640320n;
        const C3_OVER_24 = C*C*C / 24n;

        const iterations = Number(digits) / 14.18111561;
        const limit = BigInt(Math.floor(iterations)) + 1n;

        self.postMessage({type:"status", msg:`二分展开 (项数 ${limit})`});

        function BS(a, b){
            if(b - a === 1n){
                const k = a;
                if(k === 0n){
                    return {P:1n, Q:1n, T:13591409n};
                }
                const P = -(6n*k - 5n)*(2n*k - 1n)*(6n*k - 1n);
                const Q = k*k*k * C3_OVER_24;
                const T = P * (545140134n*k + 13591409n);
                return {P,Q,T};
            }
            const m = (a+b)/2n;
            const L = BS(a,m);
            const R = BS(m,b);
            return {
                P: L.P*R.P,
                Q: L.Q*R.Q,
                T: L.T*R.Q + L.P*R.T
            };
        }

        const S = BS(0n, limit);

        self.postMessage({type:"status", msg:"准备 sqrt..."});

        const extra = 20n;
        const total = digits + extra;

        // 安全构造 10^n
        function pow10(n){
            return BigInt("1" + "0".repeat(Number(n)));
        }

        const M = pow10(total);
        const sqrtBase = 10005n * (M*M);

        // sqrt 初值
        let guess = 100n * M;

        function sqrtBig(n, x){
            let x0 = x;
            let x1 = (x0 + n/x0) >> 1n;
            while(x1 < x0){
                x0 = x1;
                x1 = (x0 + n/x0) >> 1n;
            }
            return x0;
        }

        const s = sqrtBig(sqrtBase, guess);

        self.postMessage({type:"status", msg:"最终计算 π ..."});

        const pi = (426880n * S.Q * s) / S.T;

        let str = pi.toString();
        str = str.slice(0, Number(digits)+1);
        if(str.length>1) str = str[0]+"."+str.slice(1);

        const end = performance.now();

        self.postMessage({
            type:"result",
            pi:str,
            time:end-start
        });

    } catch(err){
        self.postMessage({type:"error", msg:err.message});
    }
};
</script>

<script>
const blob = new Blob([document.getElementById("worker-code").textContent], {
    type: "text/javascript"
});
const workerURL = URL.createObjectURL(blob);

let worker = null;

const btnCalc = document.getElementById("btnCalc");
const statusText = document.getElementById("status-text");
const resultArea = document.getElementById("result-area");
const timeVal = document.getElementById("timeVal");
const lenVal = document.getElementById("lenVal");

function startCalc(){
    const digits = parseInt(document.getElementById("targetDigits").value);

    if(worker) worker.terminate();
    worker = new Worker(workerURL);

    btnCalc.disabled = true;
    statusText.innerText = "启动 Worker...";
    resultArea.innerText = "计算中...";
    resultArea.style.opacity = 0.5;

    worker.postMessage(digits);

    worker.onmessage = function(e){
        const d = e.data;

        if(d.type === "status"){
            statusText.innerText = d.msg;
        } else if(d.type === "result"){
            statusText.innerText = "完成";
            timeVal.innerText = (d.time/1000).toFixed(3)+" s";
            resultArea.style.opacity = 1;
            resultArea.innerText = d.pi;
            lenVal.innerText = (d.pi.length - 2);
            btnCalc.disabled = false;
        } else if(d.type === "error"){
            statusText.innerText = "错误: "+d.msg;
            btnCalc.disabled = false;
        }
    };

    worker.onerror = e=>{
        statusText.innerText = "Worker Err: "+e.message;
        btnCalc.disabled = false;
    };
}
</script>
</body>
</html>
