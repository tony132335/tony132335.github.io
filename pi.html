<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi 极速计算器 (修复完美版)</title>

    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        #result-area {
            white-space: pre-wrap;
            background: #111;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #333;
            height: 400px;
            overflow-y: auto;
        }
        .controls {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>

<h1>π 计算器（Chudnovsky / 修复版）</h1>

<div class="controls">
    目标位数：
    <input id="digits" type="number" value="2000" step="100">
    <button onclick="start()">开始计算</button>
</div>

<div id="status"></div>

<div id="result-area">等待中...</div>

<script id="worker-code" type="javascript/worker">

// ========== Worker 内代码 ==========

function pow10(n) {
    return BigInt("1" + "0".repeat(Number(n)));
}

self.onmessage = function (e) {
    const digits = BigInt(e.data);
    const startTime = performance.now();

    try {
        const C = 640320n;
        const C3_24 = C * C * C / 24n;

        const iterations = Number(digits) / 14.181647462725477;
        const nIter = BigInt(Math.floor(iterations)) + 1n;

        postMessage({ type: "status", msg: "生成叶节点..." });

        // ====== 生成叶节点 ======
        let terms = [];
        for (let k = 0n; k < nIter; k++) {
            if (k === 0n) {
                terms.push({ P: 1n, Q: 1n, T: 13591409n });
            } else {
                const P = (6n * k - 5n) * (2n * k - 1n) * (6n * k - 1n);
                const Q = k * k * k * C3_24;
                const term = 545140134n * k + 13591409n;

                const sign = (k % 2n === 1n) ? -1n : 1n; // 正确的 (-1)^k
                const T = sign * P * term;

                terms.push({ P, Q, T });
            }
        }

        postMessage({ type: "status", msg: "二分合并中..." });

        // ====== 二分拆分合并 ======
        while (terms.length > 1) {
            let next = [];
            for (let i = 0; i < terms.length; i += 2) {
                if (i + 1 >= terms.length) {
                    next.push(terms[i]);
                } else {
                    const A = terms[i];
                    const B = terms[i + 1];
                    next.push({
                        P: A.P * B.P,
                        Q: A.Q * B.Q,
                        T: A.T * B.Q + A.P * B.T
                    });
                }
            }
            terms = next;
        }

        const BS = terms[0];

        postMessage({ type: "status", msg: "计算 sqrt..." });

        // ====== sqrt(10005 * 10^(2*(digits+extra))) ======
        const extra = 20n;
        const total = digits + extra;

        const bigN = BigInt("10005" + "0".repeat(Number(2n * total)));
        const initial = 100n * pow10(total);

        function bigSqrt(n, x0) {
            let x = x0;
            let y = (x + n / x) >> 1n;
            while (y < x) {
                x = y;
                y = (x + n / x) >> 1n;
            }
            return x;
        }

        const sqrtVal = bigSqrt(bigN, initial);

        postMessage({ type: "status", msg: "最终除法..." });

        // ========== Chudnovsky 公式 ==========
        let piInt = (426880n * BS.Q * sqrtVal) / BS.T;

        // ========== 去 extra 精度（关键修复） ==========
        piInt = piInt / pow10(extra);

        // 转字符串并插入小数点
        let out = piInt.toString();
        out = out[0] + "." + out.slice(1);

        const time = ((performance.now() - startTime) / 1000).toFixed(3);

        postMessage({ type: "result", pi: out, time });

    } catch (err) {
        postMessage({ type: "error", msg: err.toString() });
    }
};

</script>


<script>
let worker = null;

function start() {
    const digits = parseInt(document.getElementById("digits").value);
    const status = document.getElementById("status");
    const output = document.getElementById("result-area");

    if (digits > 50000) {
        alert("浏览器跑太大的位数会爆内存，建议 ≤ 50000。");
        return;
    }

    if (worker) worker.terminate();

    const blob = new Blob(
        [document.getElementById("worker-code").textContent],
        { type: "text/javascript" }
    );
    worker = new Worker(URL.createObjectURL(blob));

    status.innerText = "启动中...";
    output.innerText = "计算中...";

    worker.postMessage(digits);

    worker.onmessage = function (e) {
        const data = e.data;
        if (data.type === "status") {
            status.innerText = data.msg;
        } else if (data.type === "result") {
            status.innerText = "完成，用时 " + data.time + " 秒";
            output.innerText = data.pi;
        } else if (data.type === "error") {
            status.innerText = "错误： " + data.msg;
        }
    };
}
</script>

</body>
</html>
