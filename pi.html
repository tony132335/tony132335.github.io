<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时 Pi 计算器 (Spigot算法)</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace; /* 使用等宽字体 */
            background-color: #1e1e1e;
            color: #00ff41; /* 黑客帝国绿 */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 10px;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }

        .controls {
            margin-bottom: 20px;
            background: #333;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            margin: 0 5px;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #005f9e;
        }

        button.stop {
            background-color: #d32f2f;
        }

        button.stop:hover {
            background-color: #a52222;
        }

        .status {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        #pi-content {
            width: 90%;
            max-width: 1000px;
            background-color: #000;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 4px;
            word-wrap: break-word; /* 关键：让数字自动换行 */
            font-size: 18px;
            line-height: 1.5;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            min-height: 200px;
        }

        .digit {
            display: inline;
        }
        
        /* 为了突出显示刚刚计算出来的数字 */
        @keyframes flash {
            0% { color: white; background: #00ff41; }
            100% { color: #00ff41; background: transparent; }
        }
        
        .new-digit {
            animation: flash 0.5s ease-out;
        }
    </style>
</head>
<body>

    <h1>&pi; Pi 实时计算器</h1>
    
    <div class="controls">
        <button id="btnStart" onclick="startCalculation()">开始计算</button>
        <button id="btnStop" class="stop" onclick="stopCalculation()">暂停</button>
        <button onclick="resetCalculation()">重置</button>
    </div>

    <div class="status">
        当前已计算位数: <strong id="count">0</strong>
    </div>

    <div id="pi-content">3.</div>

    <script>
        // 获取DOM元素
        const contentDiv = document.getElementById('pi-content');
        const countSpan = document.getElementById('count');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');

        // 状态变量
        let isRunning = false;
        let totalDigits = 0;
        
        // 算法核心变量 (BigInt)
        // 使用 Jeremy Gibbons 的无界 Spigot 算法 (流式算法)
        let q = 1n;
        let r = 0n;
        let t = 1n;
        let k = 1n;
        let n = 3n;
        let l = 3n;

        function startCalculation() {
            if (isRunning) return;
            isRunning = true;
            
            btnStart.disabled = true;
            btnStart.style.opacity = 0.5;
            btnStop.disabled = false;
            btnStop.style.opacity = 1;

            // 启动循环
            calculateStep();
        }

        function stopCalculation() {
            isRunning = false;
            btnStart.disabled = false;
            btnStart.style.opacity = 1;
            btnStop.disabled = true;
            btnStop.style.opacity = 0.5;
        }

        function resetCalculation() {
            stopCalculation();
            // 重置算法变量
            q = 1n; r = 0n; t = 1n; k = 1n; n = 3n; l = 3n;
            totalDigits = 0;
            // 重置UI
            contentDiv.innerHTML = "3.";
            countSpan.innerText = "0";
        }

        function calculateStep() {
            if (!isRunning) return;

            // 每次执行计算一批数字，而不是一个，以平衡 UI 刷新率和计算速度
            // BigInt 运算随位数增加会变慢，所以我们可以动态调整这个 batchSize，或者固定它
            const batchSize = 50; 
            let batchOutput = "";

            for (let i = 0; i < batchSize; i++) {
                // 算法核心逻辑：
                // 检查是否产生了一个确定的数字
                if (4n * q + r - t < n * t) {
                    // 输出数字 n
                    batchOutput += n.toString();
                    totalDigits++;

                    // 更新状态以计算下一位 (相当于乘以10)
                    let nr = 10n * (r - n * t);
                    n = ((10n * (3n * q + r)) / t) - 10n * n;
                    q *= 10n;
                    r = nr;
                } else {
                    // 还没有产生数字，继续迭代级数
                    let nr = (2n * q + r) * l;
                    let nn = (q * (7n * k) + 2n + r * l) / (t * l);
                    q *= k;
                    t *= l;
                    l += 2n;
                    k += 1n;
                    n = nn;
                    r = nr;
                }
            }

            // 更新 DOM
            if (batchOutput.length > 0) {
                // 我们创建一个 span 只是为了给新数字加一点特效，或者直接追加文本
                // 为了性能，当数字非常多时，直接追加文本节点是最好的
                contentDiv.insertAdjacentText('beforeend', batchOutput);
                countSpan.innerText = totalDigits;
                
                // 自动滚动到底部
                // window.scrollTo(0, document.body.scrollHeight);
            }

            // 使用 setTimeout(..., 0) 让出主线程，允许浏览器渲染UI，然后再继续计算
            setTimeout(calculateStep, 0);
        }

        // 初始化按钮状态
        btnStop.disabled = true;
        btnStop.style.opacity = 0.5;

    </script>
</body>
</html>
