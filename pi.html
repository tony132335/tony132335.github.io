<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极速 Pi 计算器 (BigInt版)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        h1 { color: #bb86fc; margin-bottom: 20px; }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        input[type="number"] {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            background-color: #2c2c2c;
            color: white;
            width: 120px;
            font-size: 16px;
            text-align: center;
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            font-weight: bold;
        }

        .btn-calc { background-color: #03dac6; color: #000; }
        .btn-calc:hover { background-color: #00b3a1; }
        .btn-calc:active { transform: scale(0.98); }

        .btn-copy { background-color: #333; color: #fff; margin-top: 10px; font-size: 14px;}
        .btn-copy:hover { background-color: #444; }

        .status {
            margin: 15px 0;
            height: 20px;
            font-size: 14px;
            color: #aaa;
        }

        textarea {
            width: 100%;
            height: 300px;
            background-color: #000;
            color: #00ff00;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            word-break: break-all;
            box-sizing: border-box;
        }

        .warning {
            font-size: 12px;
            color: #cf6679;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>极速 Pi 生成器</h1>
        
        <div class="input-group">
            <input type="number" id="digitsInput" value="1000" min="1" max="50000" placeholder="位数">
            <button class="btn-calc" onclick="startCalculation()">立即计算</button>
        </div>
        <div class="warning">建议输入 1,000 到 20,000 之间 (最大支持约 50,000)</div>

        <div class="status" id="statusText">准备就绪</div>

        <textarea id="resultArea" readonly placeholder="结果将显示在这里..."></textarea>
        
        <button class="btn-copy" onclick="copyResult()">复制结果</button>
    </div>

    <script>
        // 这是一个不会阻塞 UI 的异步包装函数
        async function startCalculation() {
            const input = document.getElementById('digitsInput');
            const resultArea = document.getElementById('resultArea');
            const statusText = document.getElementById('statusText');
            const digits = parseInt(input.value);

            if (digits < 1 || isNaN(digits)) {
                alert("请输入有效的位数");
                return;
            }
            if (digits > 100000) {
                if(!confirm("计算超过 100,000 位可能会导致浏览器短暂卡死，确定继续吗？")) return;
            }

            // UI 更新
            resultArea.value = "";
            statusText.innerText = `正在全力计算 ${digits} 位 Pi...`;
            statusText.style.color = "#bb86fc";

            // 使用 setTimeout 给浏览器一点时间渲染 "正在计算" 的文字
            setTimeout(() => {
                const startTime = performance.now();
                
                try {
                    // 核心计算逻辑
                    const piStr = calcPiMachin(digits);
                    
                    const endTime = performance.now();
                    const timeTaken = (endTime - startTime).toFixed(2);
                    
                    resultArea.value = piStr;
                    statusText.innerText = `计算完成！耗时: ${timeTaken} 毫秒`;
                    statusText.style.color = "#03dac6";
                } catch (e) {
                    statusText.innerText = "计算出错：" + e.message;
                    statusText.style.color = "#cf6679";
                }
            }, 50);
        }

        /**
         * 使用马钦公式 (Machin-like formula) 计算 Pi
         * Formula: pi/4 = 4 * arctan(1/5) - arctan(1/239)
         * 使用 BigInt 进行定点算术 (Fixed-point arithmetic)
         */
        function calcPiMachin(digits) {
            // 增加 10 位缓冲以避免最后一位的精度误差
            const k = BigInt(digits + 10);
            
            // 定义 "1" 的大小 (比如我们要算1000位，底数就是 10^1010)
            // 所有的计算都变成整数计算
            const unity = 10n ** k;

            // 计算 arctan(1/5) 和 arctan(1/239)
            // 这里的 acot(x) 等同于 arctan(1/x)
            const term1 = 4n * acot(5n, unity);
            const term2 = acot(239n, unity);

            // pi = 4 * (4 * arctan(1/5) - arctan(1/239))
            const piBigInt = 4n * (term1 - term2);

            // 格式化输出
            let piStr = piBigInt.toString();
            
            // 截取我们需要的位数
            // 注意：piStr 的长度是 digits + 10 + 1 (因为 '3' 也是一位)
            // 我们需要把第一位 '3' 和后面的分开
            const formattedPi = piStr.charAt(0) + "." + piStr.slice(1, digits + 1);
            
            return formattedPi;
        }

        /**
         * 计算 arccot(x) = arctan(1/x)
         * 泰勒级数: 1/x - 1/(3x^3) + 1/(5x^5) - ...
         */
        function acot(x, unity) {
            let sum = 0n;
            let xPower = unity / x; // 第一项: 1/x (scaled)
            let n = 1n;
            let sign = 1n;
            const x2 = x * x; // 预计算 x^2

            while (xPower > 0n) {
                // 每一项是: xPower / n
                if (sign === 1n) {
                    sum += xPower / n;
                } else {
                    sum -= xPower / n;
                }

                // 准备下一项
                xPower /= x2; // xPower 变小
                n += 2n;      // 分母变大 (1, 3, 5, 7...)
                sign = -sign; // 符号翻转
            }
            return sum;
        }

        function copyResult() {
            const copyText = document.getElementById("resultArea");
            copyText.select();
            document.execCommand("copy");
            alert("结果已复制到剪贴板！");
        }
    </script>
</body>
</html>
